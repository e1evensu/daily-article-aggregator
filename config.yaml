# 每日文章聚合器配置文件
# Daily Article Aggregator Configuration

# 数据源配置
sources:
  arxiv:
    enabled: true
    categories:
      - cs.AI      # 人工智能
      - cs.CL      # 计算语言学
      - cs.CR      # 密码学与安全
    keywords:
      - security
      - safety
      - llm
    use_llm_filter: false
    max_results: 1000
  
  rss:
    enabled: true
    # 使用合并后的OPML文件（包含所有评估通过的订阅源）
    opml_path: "merged_feeds.opml"
    # 额外的OPML文件列表（用于评估）
    opml_files:
      - "rss/CyberSecurityRSS.opml"        # 网络安全RSS（完整版）
      - "rss/Chinese-Security-RSS.opml"    # 中文安全RSS
      - "rss/awesome-security-feed.opml"   # 精选安全订阅源
      - "rss/chinese-independent-blogs.opml" # 中文独立博客
      - "rss/SecureRss.opml"               # 安全RSS（大型）
      - "rss/wechatRSS.opml"               # 微信公众号RSS
      - "rss/hn-popular-blogs-2025.opml"   # HN热门博客2025（92个高质量技术博客）

# AI配置（所有值都支持环境变量覆盖）
ai:
  enabled: true
  api_base: "${OPENAI_API_BASE:https://api.openai.com/v1}"
  api_key: "${OPENAI_API_KEY}"
  model: "${OPENAI_MODEL:gpt-4o-mini}"
  max_tokens: 200000
  temperature: 0.7
  timeout: 60
  translate: true
  system_prompt: |
    你是一名专业的技术文档分析师，擅长阅读和总结技术文章。
    你的任务是：
    1. 提取文章的核心观点和关键信息
    2. 生成简洁准确的中文摘要
    3. 为文章分配合适的技术分类
    
    请确保摘要简洁明了，突出文章的主要贡献和价值。

# 飞书配置
feishu:
  webhook_url: "${FEISHU_WEBHOOK_URL}"

# 飞书多维表格配置（用于数据可视化）
feishu_bitable:
  enabled: true
  app_id: "${FEISHU_APP_ID}"
  app_secret: "${FEISHU_APP_SECRET}"
  app_token: "${FEISHU_BITABLE_APP_TOKEN:}"  # 首次运行自动创建
  table_id: "${FEISHU_BITABLE_TABLE_ID:}"    # 首次运行自动创建

# 代理配置
proxy:
  url: ""
  enabled: false

# 调度配置
schedule:
  time: "07:00"
  timezone: "Asia/Shanghai"

# 断点续传配置
# Checkpoint/Resume Configuration
checkpoint:
  enabled: true                    # 是否启用断点续传
  dir: "data/checkpoints"          # 检查点文件存储目录
  max_age_hours: 24                # 检查点最大保留时间（小时）
  save_interval: 10                # 自动保存间隔（每处理多少条后保存）

# 数据库配置
database:
  path: "data/articles.db"

# 内容处理配置
content:
  max_length: 5000000 # 最大内容长度（字符）
  truncation_marker: "\n\n... [内容已截断]"

# 新数据源配置
# New Data Sources Configuration
data_sources:
  dblp:
    enabled: true
    conferences:
      - sp      # IEEE S&P
      - ccs     # ACM CCS
      - uss     # USENIX Security
      - ndss    # NDSS
    timeout: 30
  
  nvd:
    enabled: true
    api_key: "${NVD_API_KEY:}"
    days_back: 7
    timeout: 60
    min_cvss_score: 7.0  # 只保留高危漏洞 (CVSS >= 7.0)
  
  kev:
    enabled: true
    days_back: 30
    timeout: 30
  
  huggingface:
    enabled: true
    timeout: 30
  
  pwc:
    enabled: true
    limit: 50
    timeout: 30
  
  blogs:
    enabled: true
    sources:
      - openai
      - deepmind
      - anthropic
    timeout: 30
  
  hunyuan:
    enabled: true
    timeout: 30
    days_back: 7
    page_size: 20
  
  github:
    enabled: true
    token: "${GITHUB_TOKEN:}"
    topics:
      - security
      - llm
      - ai
      - machine-learning
      - cybersecurity
    min_stars: 100
    days_back: 7
    max_results: 50
    timeout: 30
  
  anthropic_red:
    enabled: true
    timeout: 30
  
  atum_blog:
    enabled: true
    timeout: 30
    days_back: 365  # 抓取最近一年的文章

# 漏洞过滤配置
# Vulnerability Filter Configuration
vulnerability_filter:
  enabled: true
  github_star_threshold: 1000
  ip_asset_threshold: 300
  enable_ai_assessment: true
  github_token: "${GITHUB_TOKEN:}"

# 分级推送配置
# Tiered Push Configuration
tiered_push:
  enabled: true
  level1_threshold: 0.10  # 前 10%
  level2_threshold: 0.40  # 10%-40%
  # level3 为剩余部分 (40%-100%)

# 智能筛选配置
# Smart Selector Configuration
smart_selector:
  enabled: true
  max_articles: 100         # 每日最多推送文章数
  min_quality_score: 50     # 最低质量分（0-100）
  source_balance: true      # 是否平衡不同来源

# 优先级评分配置
# Priority Scoring Configuration
priority_scoring:
  enabled: true
  source_weights:
    kev: 1.5      # KEV 漏洞权重更高
    nvd: 1.2
    dblp: 1.3     # 顶会论文权重更高
    huggingface: 1.1
    pwc: 1.1
    blog: 1.0
    arxiv: 1.0
    rss: 0.8

# 知识库问答配置
# Knowledge QA Configuration
knowledge_qa:
  enabled: true
  
  # ChromaDB 配置
  chroma:
    path: "data/chroma_db"
    collection_name: "knowledge_articles"
  
  # Embedding 配置
  embedding:
    model: "Qwen/Qwen3-Embedding-8B"
  
  # 事件服务器配置
  event_server:
    host: "0.0.0.0"
    port: 8080
    verification_token: "${FEISHU_VERIFICATION_TOKEN}"
    encrypt_key: "${FEISHU_ENCRYPT_KEY:}"
  
  # 问答配置
  qa:
    max_context_turns: 5
    context_ttl_minutes: 30
    max_retrieved_docs: 5
    min_relevance_score: 0.5
    answer_max_length: 40000
  
  # 分块配置
  chunking:
    chunk_size: 500
    chunk_overlap: 50
  
  # 频率限制
  rate_limit:
    requests_per_minute: 20
    requests_per_user_minute: 5

# 话题聚合配置
# Topic Aggregation Configuration
topic_aggregation:
  enabled: true                     # 启用话题聚合
  similarity_threshold: 0.7         # 相似度阈值（0-1）
  aggregation_threshold: 3          # 聚合阈值（达到此数量触发综述）
  time_window_days: 7               # 时间窗口（天）
  title_weight: 0.6                 # 标题权重
  keyword_weight: 0.4               # 关键词权重
  use_ai_similarity: true           # 使用 AI 计算相似度（推荐）
  embedding_model: "Qwen/Qwen3-Embedding-8B"  # Embedding 模型
  # 黑名单域名（低质量来源）
  blacklist_domains:
    - csdn.net
    - zhihu.com
    - jianshu.com
    - blog.51cto.com
  # 可信来源（高质量来源）
  trusted_sources:
    - arxiv.org
    - github.com
    - openai.com
    - anthropic.com
    - deepmind.com

# RAG 增强配置
# RAG Enhancement Configuration
# Requirements: 1.1, 1.5, 2.1, 2.5, 3.3
rag_enhancement:
  enabled: true                     # 启用 RAG 增强功能
  similarity_threshold: 0.5         # 相似度阈值 [0, 1]，低于此阈值的结果将被过滤
  max_chunks_per_doc: 3             # 每文档最大分块数，0 表示无限制
  max_history_turns: 5              # 最大历史对话轮数
  dedup_threshold: 0.95             # 去重相似度阈值，高于此阈值的内容将被去重

# 飞书双向交互配置
# Feishu Interactive Bot Configuration
# Requirements: 14.x, 15.x, 16.x, 17.x
feishu_interactive:
  enabled: true                     # 启用飞书双向交互
  app_id: "${FEISHU_APP_ID}"        # 飞书应用 ID
  app_secret: "${FEISHU_APP_SECRET}" # 飞书应用密钥
  # 事件服务器配置
  event_server:
    host: "0.0.0.0"
    port: 8080
    verification_token: "${FEISHU_VERIFICATION_TOKEN}"
    encrypt_key: "${FEISHU_ENCRYPT_KEY:}"
  # 消息处理配置
  message_handling:
    always_respond: false           # 是否总是响应（不需要 @mention）
    thread_replies: true            # 是否使用线程回复
    low_confidence_threshold: 0.5   # 低置信度阈值
    low_confidence_message: "⚠️ 以下回答置信度较低，仅供参考："
    max_sources: 5                  # 最大显示来源数
  # 事件去重配置
  deduplication:
    max_size: 10000                 # 最大缓存大小
    ttl_seconds: 300                # 事件 ID 过期时间（秒）

# 统计分析系统配置
# Statistics Analysis System Configuration
# Requirements: 9.x, 10.x, 11.x, 12.x, 13.x
stats_system:
  enabled: true                     # 启用统计分析系统
  db_path: "data/stats.db"          # 统计数据库路径
  # 页面浏览统计配置
  page_views:
    dedup_window_seconds: 300       # 去重时间窗口（秒），同一用户同一文章在此时间内只计一次
  # 问答统计配置
  qa_stats:
    track_queries: true             # 是否记录查询内容
    track_sources: true             # 是否记录来源使用情况
  # 来源质量评估配置
  source_quality:
    min_fetch_count: 10             # 最小抓取次数（低于此值不计算质量分）
    low_quality_threshold: 30       # 低质量阈值（低于此分数标记为低质量）
  # 话题追踪配置
  topic_tracking:
    enabled: true                   # 启用话题追踪
    min_keyword_length: 2           # 最小关键词长度
    max_keywords_per_article: 10    # 每篇文章最大关键词数
    spike_threshold: 2.0            # 话题突增检测阈值（倍数）
    use_jieba: true                 # 使用 jieba 分词（中文）
  # API 配置
  api:
    cache_ttl_seconds: 300          # 缓存 TTL（秒）
    max_results: 100                # 最大返回结果数

# Sitemap 导入器配置
# Sitemap Importer Configuration
# Requirements: 5.1, 6.1, 7.1, 8.1
sitemap_importer:
  enabled: true                     # 启用 Sitemap 导入器
  timeout: 30                       # HTTP 请求超时时间（秒）
  user_agent: "PandaWiki-SitemapImporter/1.0"  # User-Agent
  max_concurrent: 5                 # 最大并发请求数
  delay_between_requests: 0.5       # 请求间延迟（秒）
  state_dir: "data/sitemap_state"   # 爬取状态存储目录
  source_type: "sitemap"            # 来源类型标识
  # 示例 Sitemap 配置
  # Example Sitemap configurations
  sitemaps: []
    # - url: "https://example.com/sitemap.xml"
    #   include_patterns:
    #     - "/docs/*"
    #     - "/blog/*"
    #   exclude_patterns:
    #     - "*/archive/*"
    #     - "*/tag/*"
    #   use_regex: false
    #   category: "documentation"
    #   force_refresh: false
