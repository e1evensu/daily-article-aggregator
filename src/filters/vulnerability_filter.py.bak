"""
VulnerabilityFilter - 智能漏洞过滤器
VulnerabilityFilter - Smart Vulnerability Filter

基于 GitHub star、IP 资产数量和 AI 辅助判断过滤低价值漏洞。
Filters low-value vulnerabilities based on GitHub stars, IP asset count, and AI assessment.

需求 Requirements:
- 5.1: GitHub star 低于阈值时标记为低优先级
- 5.2: 通过 GitHub API 获取项目 star 数量
- 5.3: 支持配置 GitHub star 过滤阈值
- 5.4: GitHub API 请求失败时跳过 star 过滤
- 6.1: IP 资产数量低于阈值时标记为低优先级
- 6.2: 支持配置 IP 资产过滤阈值
- 6.3: 查询受影响资产数量
- 7.1: 漏洞通过基础过滤后使用 AI 评估
- 7.3: AI 判定为"水洞"时标记为低优先级
- 7.5: AI 评估失败时保留该漏洞
"""

import logging
import re
from dataclasses import dataclass, field
from typing import Any

import requests

logger = logging.getLogger(__name__)


@dataclass
class VulnerabilityFilterResult:
    """
    过滤结果数据类
    Filter Result Data Class
    
    封装漏洞过滤的结果，包括是否通过过滤、过滤原因和附加信息。
    Encapsulates vulnerability filtering result, including pass/fail status,
    filter reasons, and additional information.
    
    Attributes:
        passed: 是否通过过滤（True 表示保留，False 表示被过滤）
        vulnerability: 原始漏洞数据
        filter_reasons: 过滤原因列表（如被过滤）
        github_stars: GitHub star 数（如有）
        ip_asset_count: IP 资产数（如有）
        ai_assessment: AI 评估结果（如有）
    """
    passed: bool = True
    vulnerability: dict[str, Any] = field(default_factory=dict)
    filter_reasons: list[str] = field(default_factory=list)
    github_stars: int | None = None
    ip_asset_count: int | None = None
    ai_assessment: str | None = None


class VulnerabilityFilter:
    """
    智能漏洞过滤器
    Smart Vulnerability Filter
    
    基于多维度指标过滤低价值漏洞：
    1. GitHub star 数量
    2. IP 资产数量
    3. AI 辅助危害评估
    
    Attributes:
        github_star_threshold: GitHub star 过滤阈值
        ip_asset_threshold: IP 资产过滤阈值
        enable_ai_assessment: 是否启用 AI 评估
        github_token: GitHub API 令牌（可选）
        ai_analyzer: AI 分析器实例（可选）
    """
    
    # GitHub URL 正则表达式
    GITHUB_URL_PATTERN = re.compile(
        r'https?://github\.com/([^/]+)/([^/\s]+)',
        re.IGNORECASE
    )
    
    def __init__(self, config: dict[str, Any], ai_analyzer: Any = None):
        """
        初始化漏洞过滤器
        Initialize Vulnerability Filter
        
        Args:
            config: 配置字典，包含以下键：
                   - github_star_threshold: GitHub star 阈值 (int, default=1000)
                   - ip_asset_threshold: IP 资产阈值 (int, default=300)
                   - enable_ai_assessment: 是否启用 AI 评估 (bool, default=True)
                   - github_token: GitHub API 令牌 (str, optional)
            ai_analyzer: AI 分析器实例（可选）
        """
        self.github_star_threshold: int = config.get('github_star_threshold', 1000)
        self.ip_asset_threshold: int = config.get('ip_asset_threshold', 300)
        self.enable_ai_assessment: bool = config.get('enable_ai_assessment', True)
        self.github_token: str | None = config.get('github_token') or None
        self.ai_analyzer = ai_analyzer
    
    def filter_vulnerabilities(
        self, 
        vulnerabilities: list[dict[str, Any]]
    ) -> list[VulnerabilityFilterResult]:
        """
        批量过滤漏洞
        Filter vulnerabilities in batch
        
        Args:
            vulnerabilities: 漏洞列表
        
        Returns:
            过滤结果列表
        """
        results: list[VulnerabilityFilterResult] = []
        
        for vuln in vulnerabilities:
            result = self.filter_single(vuln)
            results.append(result)
        
        # 统计
        passed_count = sum(1 for r in results if r.passed)
        filtered_count = len(results) - passed_count
        logger.info(
            f"VulnerabilityFilter: {passed_count} passed, {filtered_count} filtered"
        )
        
        return results
    
    def filter_single(self, vuln: dict[str, Any]) -> VulnerabilityFilterResult:
        """
        过滤单个漏洞
        Filter a single vulnerability
        
        Args:
            vuln: 漏洞数据
        
        Returns:
            过滤结果
        """
        result = VulnerabilityFilterResult(
            passed=True,
            vulnerability=vuln,
            filter_reasons=[]
        )
        
        # 1. GitHub star 过滤
        # GitHub star filtering
        github_passed, github_stars = self._check_github_stars(vuln)
        result.github_stars = github_stars
        
        if not github_passed:
            result.passed = False
            result.filter_reasons.append(
                f"GitHub stars ({github_stars}) below threshold ({self.github_star_threshold})"
            )
        
        # 2. IP 资产过滤
        # IP asset filtering
        ip_passed, ip_count = self._check_ip_assets(vuln)
        result.ip_asset_count = ip_count
        
        if not ip_passed:
            result.passed = False
            result.filter_reasons.append(
                f"IP asset count ({ip_count}) below threshold ({self.ip_asset_threshold})"
            )
        
        # 3. AI 评估（仅在基础过滤通过后）
        # AI assessment (only after basic filters pass)
        if result.passed and self.enable_ai_assessment and self.ai_analyzer:
            ai_passed, ai_assessment = self._ai_assess_vulnerability(vuln)
            result.ai_assessment = ai_assessment
            
            if not ai_passed:
                result.passed = False
                result.filter_reasons.append(
                    f"AI assessment: {ai_assessment}"
                )
        
        return result
    
    def _check_github_stars(
        self, 
        vuln: dict[str, Any]
    ) -> tuple[bool, int | None]:
        """
        检查关联项目的 GitHub star
        Check GitHub stars of associated project
        
        Args:
            vuln: 漏洞数据
        
        Returns:
            (是否通过, star 数量) 元组
        """
        # 从漏洞描述或引用中提取 GitHub 链接
        # Extract GitHub links from vulnerability description or references
        github_urls = self._extract_github_urls(vuln)
        
        if not github_urls:
            # 没有 GitHub 链接，跳过此过滤
            return True, None
        
        # 获取第一个 GitHub 仓库的 star 数
        # Get star count of the first GitHub repository
        for url in github_urls:
            stars = self._get_github_stars(url)
            if stars is not None:
                return stars >= self.github_star_threshold, stars
        
        # API 请求失败，跳过此过滤
        return True, None
    
    def _extract_github_urls(self, vuln: dict[str, Any]) -> list[str]:
        """
        从漏洞数据中提取 GitHub URL
        Extract GitHub URLs from vulnerability data
        
        Args:
            vuln: 漏洞数据
        
        Returns:
            GitHub URL 列表
        """
        urls: list[str] = []
        
        # 从描述中提取
        # Extract from description
        description = vuln.get('description', '') or vuln.get('short_description', '')
        if description:
            matches = self.GITHUB_URL_PATTERN.findall(description)
            for owner, repo in matches:
                # 清理 repo 名称（移除可能的后缀）
                if repo.endswith('.git'):
                    repo = repo[:-4]
                repo = repo.split('?')[0].split('#')[0].rstrip('/')
                urls.append(f"https://github.com/{owner}/{repo}")
        
        # 从引用中提取
        # Extract from references
        references = vuln.get('references', [])
        for ref in references:
            ref_url = ref.get('url', '') if isinstance(ref, dict) else str(ref)
            match = self.GITHUB_URL_PATTERN.search(ref_url)
            if match:
                owner, repo = match.groups()
                # 清理 repo 名称（移除可能的后缀，但保留完整名称）
                if repo.endswith('.git'):
                    repo = repo[:-4]
                repo = repo.split('?')[0].split('#')[0].rstrip('/')
                if repo:  # 确保 repo 不为空
                    urls.append(f"https://github.com/{owner}/{repo}")
        
        # 去重
        return list(dict.fromkeys(urls))
    
    def _get_github_stars(self, github_url: str) -> int | None:
        """
        获取 GitHub 仓库的 star 数
        Get GitHub repository star count
        
        Args:
            github_url: GitHub 仓库 URL
        
        Returns:
            star 数量，失败时返回 None
        """
        match = self.GITHUB_URL_PATTERN.search(github_url)
        if not match:
            return None
        
        owner, repo = match.groups()
        api_url = f"https://api.github.com/repos/{owner}/{repo}"
        
        headers = {
            'Accept': 'application/vnd.github.v3+json',
        }
        if self.github_token:
            headers['Authorization'] = f'token {self.github_token}'
        
        try:
            response = requests.get(api_url, headers=headers, timeout=10)
            response.raise_for_status()
            data = response.json()
            return data.get('stargazers_count')
        except Exception as e:
            logger.warning(f"Failed to get GitHub stars for {github_url}: {e}")
            return None
    
    def _check_ip_assets(
        self, 
        vuln: dict[str, Any]
    ) -> tuple[bool, int | None]:
        """
        检查影响的 IP 资产数量
        Check affected IP asset count
        
        Args:
            vuln: 漏洞数据
        
        Returns:
            (是否通过, 资产数量) 元组
        """
        # 预留资产测绘 API 接口
        # Reserved for asset mapping API integration
        # 目前返回 True，表示跳过此过滤
        # Currently returns True, meaning skip this filter
        
        # 如果漏洞数据中已有 ip_asset_count，使用它
        # If vulnerability data already has ip_asset_count, use it
        ip_count = vuln.get('ip_asset_count')
        
        if ip_count is not None:
            return ip_count >= self.ip_asset_threshold, ip_count
        
        return True, None
    
    def _ai_assess_vulnerability(
        self, 
        vuln: dict[str, Any]
    ) -> tuple[bool, str | None]:
        """
        AI 评估漏洞实际危害
        AI assessment of vulnerability actual impact
        
        Args:
            vuln: 漏洞数据
        
        Returns:
            (是否通过, 评估结果) 元组
        """
        if not self.ai_analyzer:
            return True, None
        
        try:
            # 调用 AI 分析器的漏洞评估方法
            # Call AI analyzer's vulnerability assessment method
            assessment = self.ai_analyzer.assess_vulnerability(vuln)
            
            if assessment is None:
                # AI 评估失败，保留漏洞
                return True, None
            
            is_significant = assessment.get('is_significant', True)
            assessment_text = assessment.get('assessment', '')
            
            return is_significant, assessment_text
            
        except Exception as e:
            # AI 评估失败，保留漏洞
            logger.warning(f"AI assessment failed: {e}")
            return True, None
    
    def get_passed_vulnerabilities(
        self, 
        results: list[VulnerabilityFilterResult]
    ) -> list[dict[str, Any]]:
        """
        获取通过过滤的漏洞列表
        Get list of vulnerabilities that passed filtering
        
        Args:
            results: 过滤结果列表
        
        Returns:
            通过过滤的漏洞列表
        """
        return [r.vulnerability for r in results if r.passed]
    
    def get_filtered_vulnerabilities(
        self, 
        results: list[VulnerabilityFilterResult]
    ) -> list[dict[str, Any]]:
        """
        获取被过滤的漏洞列表
        Get list of filtered vulnerabilities
        
        Args:
            results: 过滤结果列表
        
        Returns:
            被过滤的漏洞列表
        """
        return [r.vulnerability for r in results if not r.passed]


def filter_vulnerability(
    vuln: dict[str, Any],
    github_star_threshold: int = 1000,
    ip_asset_threshold: int = 300,
    github_stars: int | None = None,
    ip_asset_count: int | None = None,
) -> VulnerabilityFilterResult:
    """
    过滤单个漏洞（独立函数，用于属性测试）
    Filter a single vulnerability (standalone function for property testing)
    
    Args:
        vuln: 漏洞数据
        github_star_threshold: GitHub star 阈值
        ip_asset_threshold: IP 资产阈值
        github_stars: 预设的 GitHub star 数（用于测试）
        ip_asset_count: 预设的 IP 资产数（用于测试）
    
    Returns:
        过滤结果
    
    Examples:
        >>> vuln = {'cve_id': 'CVE-2024-1234', 'description': 'Test'}
        >>> result = filter_vulnerability(vuln, github_stars=500, github_star_threshold=1000)
        >>> result.passed
        False
    """
    result = VulnerabilityFilterResult(
        passed=True,
        vulnerability=vuln,
        filter_reasons=[]
    )
    
    # GitHub star 过滤
    if github_stars is not None:
        result.github_stars = github_stars
        if github_stars < github_star_threshold:
            result.passed = False
            result.filter_reasons.append(
                f"GitHub stars ({github_stars}) below threshold ({github_star_threshold})"
            )
    
    # IP 资产过滤
    if ip_asset_count is not None:
        result.ip_asset_count = ip_asset_count
        if ip_asset_count < ip_asset_threshold:
            result.passed = False
            result.filter_reasons.append(
                f"IP asset count ({ip_asset_count}) below threshold ({ip_asset_threshold})"
            )
    
    return result
